# the iceprogduino program is targeting POSIX dependencies not available on windows
# winiceprogduino does not support writing to offsets
# WSL serial passthrough is basic and doesn't support IOCTLs needed for arduino/iceprogduino
# usbipd has many issues / can't be bothered unravelling

# install python 3.12 (linux)
sudo apt update
sudo apt install software-properties-common
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt install python3.11 python3.11-venv

# install git and clone repos
sudo apt install git
mkdir src && cd src
git clone git@gitlab.com:gcpd88/nand2tetris-fpga.git # requires ssh config
git clone https://github.com/OLIMEX/iCE40HX1K-EVB.git

## install apio + dependencies
cd nand2tetris-fpga
python3.11 -m venv .venv
source .venv/bin/activate
python -m pip install apio
apio install oss-cad-suite
apio install examples
# apio install gtkwave # apio artifact is windows only

sudo apt install gtkwave
sudo apt install tio # serial client
sudo apt install xvfb # not needed on wsl

## build + install the programmer
cd ../iCE40HX1K-EVB/programmer/iceprogduino
sudo apt install build-essential
make
sudo make install

## prepare arduino dependencies
cd ~ && curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
sudo ln -s ~/bin/arduino-cli /usr/local/bin/arduino-cli
arduino-cli core install arduino:avr
arduino-cli lib install "Adafruit GFX Library@1.2.3"
wget https://github.com/Marzogh/SPIMemory/archive/refs/tags/v2.2.0.zip -O SPIMemory-2.2.0.zip
unzip SPIMemory-2.2.0.zip -d ~/Arduino/libraries/

# enable write perms on the serial port
sudo chmod a+rw /dev/ttyACM0

## flash the arduino
# COM passthrough from WSL doesn't work / need to flash from windows if not using pure linux
arduino-cli compile --upload -p /dev/ttyACM0 --fqbn arduino:avr:leonardo "/home/veris/src/nand2tetris-fpga/tools/olimexino-32u4 firmware/iceprog"
arduino-cli compile --upload -p /dev/ttyACM0 --fqbn arduino:avr:leonardo /home/veris/src/MOD-LCD2.8RTP/SOFTWARE/Arduino/graphicstest_olimex_NS2009

# enable headless display for ssh (skip on WSL)
Xvfb :2 -screen 0 1024x768x24 &
export DISPLAY=:2

# upload test program
cd ~/src/nand2tetris-fpga
apio examples -d iCE40-HX1K-EVB/leds
cd iCE40-HX1K-EVB/leds
apio sim
apio build
apio upload

## windows: this is a dead end / for posterity only

winget install -e --id ArduinoSA.CLI # restart shell for PATH
choco install make
python -m serial.tools.miniterm COM3 115200 --encoding hexlify
winiceprogduino.exe -ICOM3 -t # doesn't support -o for offset